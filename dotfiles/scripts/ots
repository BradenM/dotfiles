#!/usr/bin/env bash

# Script for creating a one time secret via:
# onetimesecret.com
# See: https://github.com/onetimesecret/onetimesecret

API_URL=https://onetimesecret.com/api/v1
SECRET_URL="https://onetimesecret.com/secret"

get_secret_url() {
	local secret_key="${1?}"
	printf "%s/%s" "$SECRET_URL" "$secret_key"
}

get_data() {
	local input
	if [ "$#" -gt 0 ]; then
		input="${1}"
	else
		while IFS= read -r line
		do
			input="$input$line"
		done
	fi
	result="${input?Missing input}"
	printf "%s" "$result"
}

main() {
	local secret
	secret=$(get_data "$@")
	# 3 days default
	local ttl="${2:-259200}"
	local response secret_id secret_url
	response=$(http post "${API_URL}/share" secret=="${secret}" ttl=="$ttl")
	secret_id=$(jq -r '.secret_key' <<<"$response")
	secret_url=$(get_secret_url "$secret_id")
	echo 1>&2 Response:
	jq <<<"${response}" 1>&2
	echo 1>&2 Copied secret url to clipboard!
	wl-copy -n <<<"$secret_url"
	printf "%s\n" "$secret_url"
}

main "$@"
