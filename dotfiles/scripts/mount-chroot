#!/usr/bin/env bash

# check root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# validate args
if [ "$#" -lt 2 ]; then
    echo "Usage: $0 <root_partition> <mount_point> [boot_partition] [boot_mount_point]" >&2
    echo "Example: $0 /dev/sdb1 /mnt /dev/sdb2 /mnt/boot" >&2
    exit 1
fi

root_partition="$1"
mount_point="$2"
boot_partition="${3:-}" # Make boot_partition optional
boot_mount_point="${4:-$mount_point/boot}" # Default boot_mount_point to $mount_point/boot if not provided

# Mount the root filesystem
echo "Mounting the root filesystem..."
sudo mount "$root_partition" "$mount_point"

# Mount the boot partition if specified
if [ -n "$boot_partition" ]; then
    echo "Mounting the boot partition..."
    sudo mount "$boot_partition" "$boot_mount_point"
fi

# Mount essential virtual filesystems
echo "Mounting essential virtual filesystems..."
sudo mount --types proc /proc "$mount_point"/proc
sudo mount --rbind /sys "$mount_point"/sys
sudo mount --make-rslave "$mount_point"/sys
sudo mount --rbind /dev "$mount_point"/dev
sudo mount --make-rslave "$mount_point"/dev
sudo mount --bind /run "$mount_point"/run

# Chroot into the new environment
echo "Entering chroot environment..."
sudo chroot "$mount_point" /bin/bash

echo "You are now in the chroot environment. To exit, type 'exit' or press Ctrl+D."
